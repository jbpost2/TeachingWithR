---
title: "Manipulating Data: Creating New Variables"
author: "Justin Post"
output: 
      ioslides_presentation:
         css: ../css/style.css
         widescreen: true
logo: ../img/logo.png
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(haven)
options(dplyr.print_min = 5)
options(tibble.print_min = 5)
library(knitr)
opts_chunk$set(message = FALSE, cache = TRUE, warning = FALSE)
```


## Recap/Next Up!

- Data manipulation idea  

- Documenting with Markdown

- Logical statements 

- `dplyr`

- Creating new variables  

     + Conditional execution (if then)  
     + For loops  
     + Vectorized functions   
     
- Reshaping data

 

## Data manipulation idea  

We may want to subset our full data set or create new data   

- Create new variables

```{r, echo = FALSE, fig.align='center', out.width = "500px"}
knitr::include_graphics("../img/createVarVisualF.png")
```

 
## Creating New Variables  

Given a data frame and an appropriate length vector (a new variable), you can use `cbind` (column bind) to add the variable to the dataframe 

```{r}
temp <- cbind(iris, extra = rep("a", 150))
str(temp)
```


 
## Creating New Variables  

Or simply add as a named (list) element!  

```{r}
iris$extra <- rep("a", 150)
str(iris)
```



## Creating New Variables  

Better method: use `dplyr`!

- `mutate()` - add newly created **column(s)** to current data frame 

- `transmute()` - create new data frame with created variable(s)  



## Creating New Variables  

Better method: use `dplyr`!

- `mutate()` - add newly created **column(s)** to current data frame 

- `transmute()` - create new data frame with created variable(s)  

- Syntax:  

`mutate(data, newVarName = functionOfData, newVarName2 = functionOfData, ...)`  



## Creating New Variables  

- Consider a data set on movie ratings  

```{r,eval=TRUE}
library(fivethirtyeight)
fandango
```


## Creating New Variables  

- `mutate()` - add newly created **column(s)** to current data frame 

```{r}
##Create an average rottentomatoes score variable
fandango %>% mutate(avgRotten = (rottentomatoes + rottentomatoes_user)/2)
```


## Creating New Variables  

- `mutate()` - add newly created **column(s)** to current data frame 

```{r}
#can't see it!
fandango %>% mutate(avgRotten = (rottentomatoes + rottentomatoes_user)/2) %>% 
  select(film, year, avgRotten, everything())
```


## Creating New Variables  

- `mutate()` - add newly created **column(s)** to current data frame 

- Add more than one variable

```{r}
fandango %>% 
  mutate(avgRotten = (rottentomatoes + rottentomatoes_user)/2, 
         avgMeta = (metacritic_norm + metacritic_user_nom)/2) %>%
  select(film, year, avgRotten, avgMeta, everything())
```



## Creating New Variables  

- `transmute()` - create new data frame with created variable(s)  

```{r}
#transmute will keep the new variable(s) only
fandango %>% transmute(avgRotten = (rottentomatoes + rottentomatoes_user)/2)
```


## Creating New Variables  

- `transmute()` - create new data frame with created variable(s)  

```{r}
#transmute will keep the new variable(s) only
fandango %>% transmute(avgRotten = (rottentomatoes + rottentomatoes_user)/2, 
                       avgMeta = (metacritic_norm + metacritic_user_nom)/2) 
```



## Creating New Variables  

`mutate` and `transmute` can also use 'window' functions  

 - Functions that take a vector of values and return another vector of values (see [Cheat sheet](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf))
 
```{r}
fandango %>% select(rottentomatoes) %>% mutate(cumulativeSum = cumsum(rottentomatoes))
```



## Creating New Variables  

`mutate` and `transmute` can also use some statistical functions
 
```{r}
fandango %>% select(rottentomatoes) %>% 
  mutate(avg = mean(rottentomatoes), sd = sd(rottentomatoes))
```

## Creating New Variables  

`mutate` and `transmute` can also use some statistical functions

- `group_by` to create summaries for groups (more on this later)
 
```{r}
fandango %>% select(year, rottentomatoes) %>% 
  group_by(year) %>% mutate(avg = mean(rottentomatoes), sd = sd(rottentomatoes))
```



## Creating New Variables  
**Conditional Execution with If then, If then else**

- Often want to execute statements conditionally to create a variable

- `if` `then` `else` syntax

<div style="float: left; width: 45%;">
```{r,eval=FALSE}
if (condition) {
  then execute code
} 

#if then else
if (condition) {
  execute this code  
} else {
  execute this code
}
```
</div>


<div style="float: right; width: 45%;">
```{r,eval=FALSE}
#Or more if statements
if (condition) {
  execute this code  
} else if (condition2) {
  execute this code
} else if (condition3) {
  execute this code
} else {
  #if no conditions met
  execute this code
}
```
</div>




## Creating New Variables  
**Conditional Execution with If then, If then else**

- Consider built-in data set `airquality`  

    + daily air quality measurements in New York  
    
    + from May (Day 1) to September (Day 153) in 1973  
    

## Creating New Variables  
**Conditional Execution with If then, If then else**

- Consider built-in data set `airquality`  

```{r}
airquality <- as_tibble(airquality)
airquality
```


## Creating New Variables  
**Conditional Execution with If then, If then else**

Want to code a wind category variable    

 + high wind days (wind $\geq$ 15mph)  
 + windy days     (10mph $\leq$ wind < 15mph)  
 + lightwind days (6mph $\leq$ wind < 10mph)  
 + calm days      (wind $\leq$ 6mph)


## Creating New Variables  
**Conditional Execution with If then, If then else**

Want to code a wind category variable    

Issue: `if(condition)` can only take in a single comparison  

```{r, error = TRUE, message = TRUE, warning = TRUE}
if(airquality$Wind >= 15) { 
  "High Wind"
  }
```



## Creating New Variables  
**Conditional Execution with If then, If then else**

Want to code a wind category variable    

 + high wind days (15mph $\leq$ wind)  
 + windy days     (10mph $\leq$ wind < 15mph)  
 + lightwind days (6mph $\leq$ wind < 10mph)  
 + calm days      (wind $\leq$ 6mph)  

Initial plan    

  + loop through each observation    
  
  + use if then else to determine wind status    
  
    

## Looping in R  

- There are a number of ways to do looping in R  

    + `for()`  
    + `while()`
    + `repeat()`
    
- Idea: 
    + Run code repeatedly changing something each time
    

## Looping in R  

- Syntax  

```{r,eval=FALSE}
for(index in values){
  code to be run
}
```

> - index defines 'counter' or variable that varies

> - 'values' define which values index takes on


## Looping in R  

- index defines 'counter' or variable that varies

- 'values' define which values index takes on

```{r}
for (i in 1:10){
  print(i)
}
```


## Looping in R  

- index defines 'counter' or variable that varies

- 'values' define which values index takes on

```{r}
for (index in c("cat","hat","worm")){
  print(index)
}
```


## Creating New Variables  
**Conditional Execution with If then, If then else**

Want to code a wind category variable    

```{r}
status<-vector() #initialize vector to save results

for (i in 1:nrow(airquality)){
  if(airquality$Wind[i] >= 15){
    status[i] <- "HighWind"
  } else if (airquality$Wind[i] >= 10){
    status[i] <- "Windy"
  } else if (airquality$Wind[i] >= 6){
    status[i] <- "LightWind"
  } else if (airquality$Wind[i] >= 0){
    status[i] <- "Calm"
  } else {
    status[i] <- "Error"
  }
}
```


## Creating New Variables  
**Conditional Execution with If then, If then else**

```{r}
airquality$status <- status
airquality$status
```



## Looping in R  

**Other things to know**  

- `break` kicks you out of the loop  

```{r}
for (i in 1:5){
	if (i == 3){ 
	  break 
	  }
  print(i)
}
```



## Looping in R  

**Other things to know**  

- `next` jumps to the next iteration of the loop  

```{r}
for (i in 1:5){
	if (i == 3){
	  next
	} 
  print(i)
}
```


## Looping in R  

**Other things to know**  

- `while` loop similar  

```{r, eval = FALSE}
while(condition) {
	expression to evaluate
  modify condition?
}
```



## Looping in R  

**Other things to know**  

For loops inefficient in R  

> + R interpreted language  

> + Must figure out how to evaluate code at each iteration of loop  

> + Slows it down  



## Looping in R  

**Other things to know**  

For loops inefficient in R  

 + R interpreted language  

 + Must figure out how to evaluate code at each iteration of loop  
 
 + Slows it down  

Vectorized functions much faster!  

> + Vectorized function: works on entire vector at once  

> + Avoids costly computation time  
   


## Creating New Variables  
**Vectorized ifelse**

- `ifelse()` is a vectorized version of `if then else`

- Syntax

```{r,eval=FALSE}
ifelse(vector_condition, if_true_do_this, if_false_do_this)
```


## Creating New Variables  
**Vectorized if else**

```{r}
ifelse(airquality$Wind >= 15, "HighWind",
          ifelse(airquality$Wind >= 10, "Windy",
                 ifelse(airquality$Wind >= 6, "LightWind", "Calm")))
```



## Creating New Variables  
**Vectorized if else**

- Can use with `transmute()` or `mutate()` 

```{r}
mutate(airquality, status = ifelse(airquality$Wind >= 15, "HighWind",
                                ifelse(airquality$Wind >= 10, "Windy",
                                       ifelse(airquality$Wind >= 6, "LightWind", "Calm")))
)
```



## Creating New Variables  

- Compare speed of for loop and vectorized version

- `microbenchmark` package runs code repeatedly, returns summary stats

```{r}
#install if needed
library(microbenchmark)
```


## Creating New Variables  

- Compare speed of for loop and vectorized version

```{r}
loopTime <- microbenchmark(
  for (i in 1:nrow(airquality)){
    if(airquality$Wind[i] >= 15){
      status[i] <- "HighWind"
    } else if (airquality$Wind[i] >= 10){
      status[i] <- "Windy"
    } else if (airquality$Wind[i] >= 6){
      status[i] <- "LightWind"
    } else if (airquality$Wind[i] >= 0){
      status[i] <- "Calm"
    } else{
      status[i] <- "Error"
    }
  }
, unit = "us")
```


## Creating New Variables  

- Compare speed of for loop and vectorized version

```{r}
vectorTime <- microbenchmark(
  ifelse(airquality$Wind >= 15, "HighWind",
            ifelse(airquality$Wind >= 10, "Windy",
                   ifelse(airquality$Wind >= 6, "LightWind", "Calm")))
, unit = "us")
```

## Creating New Variables  

```{r}
loopTime
vectorTime
```


## Creating New Variables Recap!

- Add new column with `$`  

- `mutate()` - add newly created **column(s)** to current data frame 

- `transmute()` - create new data frame with created variable(s)  

    + Can use with window functions

    + Use `ifelse()` to do conditional creation
    
    + Note: `cut()` can be used to categorize a numeric variable too!



